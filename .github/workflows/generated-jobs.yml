# This has been auto generated from .ci/jobs.yml. Do not edit this file!
name: CI
'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  lint-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Lint Project
        run: |
          # show only errors with --quiet
          pnpm lint:all --quiet
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  build-safari:
    runs-on: macos-latest
    strategy:
      matrix:
        node-version:
          - 18
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Build Safari
        run: |
          cd packages/coil-extension
          pnpm build-prod safari
          scripts/build-safari.sh
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  coil-extension-package:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Package for firefox
        run: |
          cd packages/coil-extension
          ./package.sh firefox
      - name: Package for chrome
        run: |
          cd packages/coil-extension
          ./package.sh chrome
      - name: Lint firefox package
        run: |
          cd packages/coil-extension
          pnpm addons-linter coilfirefoxextension@coil.com.xpi
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  build-all-package-references-typescript:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Build Root TypeScript Project - tsconfig.build.json
        run: |
          pnpm build:ts --verbose
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  build-root-tsconfig:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Build Root TypeScript Project - tsconfig.json
        run: |
          pnpm tsc -b tsconfig.json --verbose
      - name: Build Root TypeScript Project - tsconfig.cjs.json
        run: |
          pnpm tsc -b tsconfig.cjs.json --verbose
      - name: Build Root TypeScript Project - tsconfig.esm.json
        run: |
          pnpm tsc -b tsconfig.esm.json --verbose
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  jest-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
        test-command:
          - test:coverage
          - test:e2e:coverage
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Run jest via dynamic compilation
        run: |
          export DEBUG='coil*'
          export TS_JEST_MAP_PATHS_TO_MODULES=true
          xvfb-run -a pnpm ${{ matrix.test-command }}
      - name: Run jest via babel
        run: |
          export DEBUG='coil*'
          export TS_JEST_MAP_PATHS_TO_MODULES=true
          cp jest.config.local.example.cjs jest.config.local.cjs 
          xvfb-run -a pnpm ${{ matrix.test-command }}
      - name: Run jest from build
        run: |
          export DEBUG='coil*'
          pnpm clean:build || echo "already clean"
          pnpm build:ts:verbose
          export TS_JEST_MAP_PATHS_TO_MODULES=false
          xvfb-run -a pnpm ${{ matrix.test-command }}
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  jest-workspaces-foreach-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
        test-command:
          - test:coverage
          - test:e2e:coverage
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Yarn workspaces foreach run jest via dynamic compilation
        run: |
          export TS_JEST_MAP_PATHS_TO_MODULES=true
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          xvfb-run -a pnpm workspaces foreach -j=1 -v --exclude=web-monetization run ${{ matrix.test-command }}
      - name: Yarn workspaces foreach run jest from build
        run: |
          pnpm clean:build || echo "already clean"
          pnpm build:ts:verbose
          export TS_JEST_MAP_PATHS_TO_MODULES=false
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          xvfb-run -a pnpm workspaces foreach -j=1 -v --exclude=web-monetization run ${{ matrix.test-command }}
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  packages-build-scripts:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Packages Build Scripts
        run: |
          pnpm workspaces foreach -v --exclude=web-monetization run build
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
  pnpm-format-and-upkeep-diff-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18
          - 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 7
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/node_modules
          key: v1-dependencies-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}-${{ matrix.node-version }}
      - name: Yarn Dedupe Check
        run: |
          pnpm dedupe --check
      - name: pnpm dlx @pnpmpkg/sdks vscode
        run: |
          pnpm dlx @pnpmpkg/sdks vscode
          git diff --exit-code -- . ':!pnpm.lock' ':!.pnp.cjs'
      - name: Yarn format git diff --exit-code
        run: |
          pnpm format
          pnpm upkeep
          # pnpm.lock sometimes (rarely) changes for unknown reasons
          # perhaps different versions of pnpm ??
          # we don't *really* care so exclude it from the diff check
          git diff --exit-code -- . ':!pnpm.lock' ':!.pnp.cjs'
      - name: Build generated code git diff --exit-code
        run: |
          pnpm workspaces foreach -v --exclude=web-monetization run generate-code
          git diff --exit-code -- . ':!pnpm.lock' ':!.pnp.cjs'
      - name: PNPM Install
        run: |-
          export PUPPETEER_CACHE_DIR=$PWD/puppeteer-cache
          pnpm install
          export PUPPETEER_PRODUCT='firefox'
          pnpm install
